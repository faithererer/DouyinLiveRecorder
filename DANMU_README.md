# 抖音直播弹幕录制功能说明

## 功能概述

本项目已集成抖音直播弹幕录制功能，可以在录制视频的同时自动录制弹幕，生成XML格式的弹幕文件，支持在本地播放器中加载显示。

## 主要特性

- ✅ **自动启动**: 检测到抖音主播开播时自动开启弹幕录制
- ✅ **文件名一致**: 弹幕文件与视频文件名保持一致
- ✅ **分段支持**: 支持视频自动分段时弹幕文件也相应分段
- ✅ **XML格式**: 生成标准XML格式弹幕文件，兼容主流播放器
- ✅ **实时录制**: 实时接收并保存弹幕数据
- ✅ **错误恢复**: 支持连接断开自动重连

## 配置说明

### 1. 基础配置

在 `config/config.ini` 文件中的 `[弹幕录制设置]` 部分进行配置：

```ini
[弹幕录制设置]
是否启用弹幕录制 = 是
弹幕录制平台(逗号分隔) = 抖音
弹幕文件保存格式 = xml
弹幕录制是否跟随视频分段 = 是
弹幕录制重连次数 = 3
弹幕录制心跳间隔(秒) = 30
```

### 2. 配置项说明

- **是否启用弹幕录制**: 控制是否启用弹幕录制功能
- **弹幕录制平台**: 支持弹幕录制的平台列表，目前支持"抖音"
- **弹幕文件保存格式**: 弹幕文件格式，目前支持"xml"
- **弹幕录制是否跟随视频分段**: 当视频分段录制时，弹幕是否也分段保存
- **弹幕录制重连次数**: 连接断开时的最大重连次数
- **弹幕录制心跳间隔**: WebSocket心跳包发送间隔

### 3. Cookie配置

确保在 `[Cookie]` 部分配置了有效的抖音Cookie：

```ini
[Cookie]
抖音cookie = 你的抖音cookie
```

## 使用方法

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

新增的依赖包：
- `websocket-client>=1.6.0` - WebSocket客户端
- `protobuf>=4.21.0` - Protocol Buffers支持

### 2. 启动录制

正常启动录制程序：

```bash
python main.py
```

当检测到抖音主播开播时，程序会：
1. 自动启动视频录制
2. 同时启动弹幕录制
3. 在控制台显示弹幕录制状态

### 3. 文件输出

录制完成后，会在相同目录下生成：
- 视频文件：`主播名_时间戳.mp4`（或其他格式）
- 弹幕文件：`主播名_时间戳.xml`

如果启用了分段录制：
- 视频文件：`主播名_时间戳_001.mp4`, `主播名_时间戳_002.mp4`, ...
- 弹幕文件：`主播名_时间戳_001.xml`, `主播名_时间戳_002.xml`, ...

## 弹幕文件格式

生成的XML弹幕文件格式如下：

```xml
<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="#s"?>
<i>
  <d p="12.34,1,25,16777215,1640995200000,0,1602022773,0" user="用户名">弹幕内容</d>
  <d p="15.67,1,25,16777215,1640995203000,0,1602022773,0" user="另一个用户">另一条弹幕</d>
</i>
```

其中 `p` 属性包含：
- 时间偏移（秒）
- 弹幕类型
- 字体大小
- 颜色
- 时间戳
- 其他参数

## 播放器支持

生成的XML弹幕文件支持以下播放器：
- **PotPlayer**: 将弹幕文件与视频文件放在同一目录，文件名相同
- **VLC**: 需要安装弹幕插件
- **MPC-HC**: 需要配置弹幕支持
- **其他支持XML弹幕的播放器**

## 故障排除

### 1. 弹幕录制未启动

检查以下项目：
- 确认 `是否启用弹幕录制 = 是`
- 确认 `弹幕录制平台` 包含 "抖音"
- 确认抖音Cookie有效
- 查看控制台日志是否有错误信息

### 2. 弹幕文件为空

可能原因：
- 直播间没有弹幕
- 网络连接问题
- Cookie过期
- 直播间限制

### 3. 连接失败

检查：
- 网络连接是否正常
- 代理设置是否正确
- Cookie是否有效

## 技术实现

### 架构设计

```
main.py (主程序)
├── 检测抖音直播状态
├── 启动视频录制
└── 启动弹幕录制
    ├── src/danmu_recorder.py (弹幕录制器)
    ├── src/douyin_protobuf.py (协议解析)
    └── WebSocket连接管理
```

### 核心模块

1. **DouyinDanmuRecorder**: 主要的弹幕录制类
2. **douyin_protobuf**: 抖音弹幕协议解析模块
3. **WebSocket管理**: 处理连接、心跳、重连

### 扩展性

代码设计支持未来扩展：
- 添加其他平台弹幕录制支持
- 支持更多弹幕文件格式
- 添加弹幕过滤和处理功能

## 注意事项

1. **Cookie有效性**: 需要定期更新抖音Cookie以确保功能正常
2. **网络稳定性**: 弹幕录制依赖WebSocket连接，需要稳定的网络环境
3. **存储空间**: 长时间录制会产生大量弹幕数据，注意磁盘空间
4. **合规使用**: 请遵守相关平台的使用条款和法律法规

## 更新日志

### v1.0.0 (2025-08-23)
- ✅ 实现抖音弹幕录制基础功能
- ✅ 支持XML格式弹幕文件生成
- ✅ 支持视频分段时弹幕同步分段
- ✅ 实现WebSocket连接管理和重连机制
- ✅ 集成到主录制程序中

## 贡献

欢迎提交Issue和Pull Request来改进弹幕录制功能。

## 许可证

本功能遵循项目原有许可证。